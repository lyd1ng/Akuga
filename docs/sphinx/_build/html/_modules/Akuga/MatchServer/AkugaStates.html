
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Akuga.MatchServer.AkugaStates &#8212; Akuga 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for Akuga.MatchServer.AkugaStates</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">from</span> <span class="nn">Akuga.MatchServer</span> <span class="k">import</span> <span class="n">GlobalDefinitions</span>
<span class="kn">import</span> <span class="nn">Akuga.MatchServer.Meeple</span>
<span class="kn">from</span> <span class="nn">Akuga.MatchServer.PathFinder</span> <span class="k">import</span> <span class="n">find_path</span>
<span class="kn">from</span> <span class="nn">Akuga.MatchServer.Position</span> <span class="k">import</span> <span class="n">Position</span>
<span class="kn">from</span> <span class="nn">Akuga.MatchServer.Player</span> <span class="k">import</span> <span class="n">NeutralPlayer</span>
<span class="kn">from</span> <span class="nn">Akuga.MatchServer.StateMachieneState</span> <span class="k">import</span> <span class="n">StateMachieneState</span> <span class="k">as</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">Akuga.EventDefinitions</span> <span class="k">import</span> <span class="p">(</span><span class="n">SUMMON_JUMON_EVENT</span><span class="p">,</span>
                                    <span class="n">SELECT_JUMON_TO_MOVE_EVENT</span><span class="p">,</span>
                                    <span class="n">SELECT_JUMON_TO_SPECIAL_MOVE_EVENT</span><span class="p">,</span>
                                    <span class="n">PICK_JUMON_EVENT</span><span class="p">,</span>
                                    <span class="n">PLAYER_HAS_WON</span><span class="p">,</span>
                                    <span class="n">MATCH_IS_DRAWN</span><span class="p">,</span>
                                    <span class="n">TURN_ENDS</span><span class="p">)</span>


<div class="viewcode-block" id="jumon_fight"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.jumon_fight">[docs]</a><span class="k">def</span> <span class="nf">jumon_fight</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">,</span> <span class="n">attacking_bonus</span><span class="p">,</span>
                <span class="n">defending_jumon</span><span class="p">,</span> <span class="n">defending_bonus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the winner and the looser as a tupel of the form</span>
<span class="sd">    ($winner, $looser). If the fight was drawn return None for</span>
<span class="sd">    both.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">attack</span> <span class="o">+</span> <span class="n">attacking_bonus</span> <span class="o">&gt;</span>\
            <span class="n">defending_jumon</span><span class="o">.</span><span class="n">defense</span> <span class="o">+</span> <span class="n">defending_bonus</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">attacking_jumon</span><span class="p">,</span> <span class="n">defending_jumon</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">attack</span> <span class="o">+</span> <span class="n">attacking_bonus</span> <span class="o">&lt;</span>\
            <span class="n">defending_jumon</span><span class="o">.</span><span class="n">defense</span> <span class="o">+</span> <span class="n">defending_bonus</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">defending_jumon</span><span class="p">,</span> <span class="n">attacking_jumon</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="IdleState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.IdleState">[docs]</a><span class="k">class</span> <span class="nc">IdleState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The representation of the idle state which is the normal</span>
<span class="sd">    state a user idles in until per decides do something.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;idle_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="IdleState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.IdleState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To allow passive special abilities the nonpersistent interference</span>
<span class="sd">        of all jumons and all arena tiles has to be cleared. Then</span>
<span class="sd">        the special ability script of all jumons (even the neutral ones)</span>
<span class="sd">        can be invoked without allowing a state change.</span>
<span class="sd">        Listen on SUMMON_JUMON_EVENT and SELECT_JUMON_TO_MOVE_EVENT as well</span>
<span class="sd">        as SELECT_JUMON_TO_SPECIAL_MOVE_EVENT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset the nonpersistent interference of all arena tiles</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">tiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">arena_tile</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">arena_tile</span><span class="o">.</span><span class="n">reset_nonpersistent_interf</span><span class="p">()</span>
        <span class="c1"># Reset the nonpersistent  interference of all jumons</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_players</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">jumon</span> <span class="ow">in</span> <span class="n">player</span><span class="o">.</span><span class="n">summoned_jumons</span><span class="p">:</span>
                <span class="n">jumon</span><span class="o">.</span><span class="n">reset_nonpersistent_interf</span><span class="p">()</span>

        <span class="c1"># Go through all players, even the neutral player</span>
        <span class="k">for</span> <span class="n">player</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_players</span><span class="p">():</span>
            <span class="c1"># Go through all jumons that player summoned</span>
            <span class="k">for</span> <span class="n">jumon</span> <span class="ow">in</span> <span class="n">player</span><span class="o">.</span><span class="n">summoned_jumons</span><span class="p">:</span>
                <span class="c1"># There is no state change planed nor are there state variables</span>
                <span class="n">jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">())</span> <span class="ow">is</span>\
                <span class="n">NeutralPlayer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span>\
                <span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">in_move_phase</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the current player is a neutral player invoke its do_a_move</span>
<span class="sd">            Function and use its return to archieve a state change.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">state_change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span>\
                <span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">do_a_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Do the state change created by the special ability</span>
<span class="sd">            of the jumon moved</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">state_change</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state_change</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVENT TYPE: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PICK_JUMON_EVENT</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                <span class="n">in_pack_phase</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The event is only valid if the current player is in the pick</span>
<span class="sd">            phase, and the jumon within the event is inside the</span>
<span class="sd">            jumon_pick_pool list</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the jumon to pick from the event</span>
            <span class="n">jumon</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">jumon_to_pick</span>
            <span class="k">if</span> <span class="n">jumon</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">jumon_pick_pool</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Only jump to the pick state if the jumon is</span>
<span class="sd">                within the pick pool</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">pick_state_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jumon_to_pick&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">}</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">pick_state</span><span class="p">,</span> <span class="n">pick_state_variables</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SUMMON_JUMON_EVENT</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                <span class="n">in_summon_phase</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The event is only valid if the current player is in the move</span>
<span class="sd">            phase, the jumon within the event is inside the</span>
<span class="sd">            jumons_to_summon list.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the jumon to summon and create the state variables dict</span>
            <span class="n">jumon</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">jumon_to_summon</span>
            <span class="c1"># Only summon the jumon if the player owns the jumon</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                    <span class="n">can_summon</span><span class="p">(</span><span class="n">jumon</span><span class="p">):</span>
                <span class="c1"># Jump to the summon state</span>
                <span class="n">summon_state_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">}</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">summon_state</span><span class="p">,</span> <span class="n">summon_state_variables</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SELECT_JUMON_TO_MOVE_EVENT</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">in_move_phase</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the jumon to move, its position and the target position</span>
<span class="sd">            from the event. The CheckMoveState will check if the move is</span>
<span class="sd">            legal or not and handles the move</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">jumon</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">jumon_to_move</span>
            <span class="n">current_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">current_position</span>
            <span class="n">target_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target_position</span>
            <span class="c1"># Only move the jumon if the current player controls the jumon</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">controls_jumon</span><span class="p">(</span><span class="n">jumon</span><span class="p">):</span>
                <span class="n">check_move_state_variables</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;jumon_to_move&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">,</span>
                    <span class="s2">&quot;current_position&quot;</span><span class="p">:</span> <span class="n">current_position</span><span class="p">,</span>
                    <span class="s2">&quot;target_position&quot;</span><span class="p">:</span> <span class="n">target_position</span><span class="p">}</span>
                <span class="c1"># Jump to the check move state</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">check_move_state</span><span class="p">,</span> <span class="n">check_move_state_variables</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SELECT_JUMON_TO_SPECIAL_MOVE_EVENT</span>\
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">in_move_phase</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Get the jumon to move, its position and the target position</span>
<span class="sd">            from the event. The CheckSpecialMoveState will check if the</span>
<span class="sd">            move is legal or not and handles the move.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">jumon</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">jumon_to_move</span>
            <span class="n">current_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">current_position</span>
            <span class="n">target_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target_position</span>
            <span class="n">check_move_state_variables</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;jumon_to_move&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">,</span>
                <span class="s2">&quot;current_position&quot;</span><span class="p">:</span> <span class="n">current_position</span><span class="p">,</span>
                <span class="s2">&quot;target_position&quot;</span><span class="p">:</span> <span class="n">target_position</span><span class="p">}</span>
            <span class="c1"># Jump to the check_special_move_state</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">check_special_move_state</span><span class="p">,</span> <span class="n">check_move_state_variables</span><span class="p">)</span>
        <span class="c1"># If no event was caught return None, so the state machiene</span>
        <span class="c1"># remains in the idle state</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="PickState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.PickState">[docs]</a><span class="k">class</span> <span class="nc">PickState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    PickState is the representation of the moment a jumon is picked</span>
<span class="sd">    from the jumon pick pool. A picked jumon is removed from the pick pool</span>
<span class="sd">    and added to the jumon_to_summon list of the current player.</span>
<span class="sd">    This way the player can summon the jumon later on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;pick_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="PickState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.PickState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the jumon to pick from the pick pool and add it to the jumons</span>
<span class="sd">        the current player can summon. Then check if the player has to</span>
<span class="sd">        switch to the summon phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_pick&quot;</span><span class="p">]</span>
        <span class="n">jumon</span><span class="o">.</span><span class="n">set_owner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">jumon_pick_pool</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">add_jumon_to_summon</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">jumon_pick_pool</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_not_neutral_length</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If there are less jumons in the pick pool than not neutral</span>
<span class="sd">            player in the playerchain the current player wont be able to</span>
<span class="sd">            pick another jumon, so per must go into the summon phase</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">set_to_summon_phase</span><span class="p">()</span>
        <span class="c1"># The turn ends, so jump to the change player state</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">change_player_state</span><span class="p">,</span> <span class="p">{})</span></div></div>


<div class="viewcode-block" id="SummonState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.SummonState">[docs]</a><span class="k">class</span> <span class="nc">SummonState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SummonState is the representation of the moment a jumon is summoned.</span>
<span class="sd">    In this state a random position if generated and its always jumped</span>
<span class="sd">    to the SummonCheckState</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;summon_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="SummonState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.SummonState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just create a random position and jump to the</span>
<span class="sd">        summon_check_state with the position and the summon as</span>
<span class="sd">        summon_check_state_variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_position</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalDefinitions</span><span class="o">.</span><span class="n">BOARD_WIDTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y_position</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GlobalDefinitions</span><span class="o">.</span><span class="n">BOARD_HEIGHT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">jumon_to_summon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">]</span>
        <span class="c1"># Build the summon_check_variables</span>
        <span class="n">summon_check_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">],</span>
            <span class="s2">&quot;summon_position&quot;</span><span class="p">:</span> <span class="n">Position</span><span class="p">(</span><span class="n">x_position</span><span class="p">,</span> <span class="n">y_position</span><span class="p">)}</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Invoke the special ability function of the current jumon</span>
<span class="sd">        and use its return for the state change of the fsm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">jumon_to_summon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">summon_check_state</span><span class="p">,</span> <span class="n">summon_check_state_variables</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="SummonCheckState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.SummonCheckState">[docs]</a><span class="k">class</span> <span class="nc">SummonCheckState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state its checked whether the jumon has to be replaced, the</span>
<span class="sd">    jummon was summond on a free position and the turn is over or</span>
<span class="sd">    a battle is triggererd</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;summon_check_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="SummonCheckState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.SummonCheckState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the summon position is free, which makes the summonation</span>
<span class="sd">        complete and ends the turn, the summon position is blocked which</span>
<span class="sd">        makes the state machiene jump back to the SummonState or the</span>
<span class="sd">        summon position is blocked by a hostile jumon which leads to</span>
<span class="sd">        a jump to the OneTileBattleState.</span>
<span class="sd">        The ability script of the active jumon is only invoked on a succesfull</span>
<span class="sd">        summoning. In other case there is a following state in which</span>
<span class="sd">        the ability script will be triggered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the jumon to summon and where to summon it</span>
        <span class="n">jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">]</span>
        <span class="n">summon_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;summon_position&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">summon_position</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the ArenaTile is free the jumon can be placed, its ability</span>
<span class="sd">            script triggers and the turn ends</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Let the current player summon this jumon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                <span class="n">handle_summoning</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">summon_position</span><span class="p">)</span><span class="o">.</span><span class="n">is_wasted</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the summoned position is a wasted land kill the jumon</span>
<span class="sd">                instead of place it on the tile</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot; Place the jumon at the arena &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">jumon</span><span class="p">,</span> <span class="n">summon_position</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Invoke the jumon special ability with the same state variables</span>
<span class="sd">            as no new state variables occured. This way enter the battlefield</span>
<span class="sd">            effects can be implemented.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">state_change</span> <span class="o">=</span> <span class="n">jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">change_player_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">state_change</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span>
                <span class="n">summon_position</span><span class="p">)),</span> <span class="n">Akuga</span><span class="o">.</span><span class="n">MatchServer</span><span class="o">.</span><span class="n">Meeple</span><span class="o">.</span><span class="n">Artefact</span><span class="p">)</span> <span class="ow">and</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_blocked_at</span><span class="p">(</span><span class="n">summon_position</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the jumon is summoned on an artefact place it on this tile</span>
<span class="sd">            and jump to the equip artefact to jumon state</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Let the current player summon this jumon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                <span class="n">handle_summoning</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="c1"># Get the artefact at this point</span>
            <span class="n">artefact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">summon_position</span><span class="p">)</span>
            <span class="c1"># Place the jumon at the arena</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">jumon</span><span class="p">,</span> <span class="n">summon_position</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create the state variables with the last state as None</span>
<span class="sd">            as there is no last position and do the state change</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">equip_artefact_to_jumon_state</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;jumon&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">,</span>
                <span class="s2">&quot;artefact&quot;</span><span class="p">:</span> <span class="n">artefact</span><span class="p">,</span>
                <span class="s2">&quot;last_position&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span>\
                <span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">owns_tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="n">summon_position</span><span class="p">)</span>\
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_blocked_at</span><span class="p">(</span><span class="n">summon_position</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the jumon at this tile is owned  by the current player</span>
<span class="sd">            the jumon has to be replaced, so jump back to the summon state</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">summon_state_variables</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_summon&quot;</span><span class="p">]}</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">summon_state</span><span class="p">,</span> <span class="n">summon_state_variables</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the tile is not empty and the jumon is not owned by</span>
<span class="sd">            the current player it has to be a hostile jumon so jump</span>
<span class="sd">            to the OneTileBattleState with the position as well as</span>
<span class="sd">            both the current and the hostile jumon attached as</span>
<span class="sd">            state variables.</span>
<span class="sd">            If the jumon to summon is going to be placed on the arena or not</span>
<span class="sd">            the player summoned it, so handle_summoning must be invoked</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                <span class="n">handle_summoning</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="n">one_tile_battle_state_variables</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;battle_position&quot;</span><span class="p">:</span> <span class="n">summon_position</span><span class="p">,</span>
                <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">,</span>
                <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">summon_position</span><span class="p">)}</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">one_tile_battle_begin_state</span><span class="p">,</span> <span class="n">one_tile_battle_state_variables</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ChangePlayerState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.ChangePlayerState">[docs]</a><span class="k">class</span> <span class="nc">ChangePlayerState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This represents the moment between the turns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;change_player_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="ChangePlayerState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.ChangePlayerState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update the current player, check for victors or if the match</span>
<span class="sd">        is drawn and handle the end of a match with throwing the right</span>
<span class="sd">        events.</span>
<span class="sd">        update the inner respresentation of the player</span>
<span class="sd">        aka check if per is dead or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span><span class="n">update_player</span><span class="p">()</span>
        <span class="c1"># Remove dead players from the player chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="c1"># Check if the match is drawn</span>
        <span class="n">is_drawn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">check_for_drawn</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_drawn</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            After this event has been handeld the state machiene should</span>
<span class="sd">            not be updated anymore</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">drawn_event</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">MATCH_IS_DRAWN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">drawn_event</span><span class="p">)</span>
        <span class="c1"># Check if a player has won</span>
        <span class="n">victor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">check_for_victory</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">victor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            After this event has been handeld the state machiene should</span>
<span class="sd">            not be updated anymore</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">won_event</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">PLAYER_HAS_WON</span><span class="p">,</span> <span class="n">victor</span><span class="o">=</span><span class="n">victor</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">won_event</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If no one has won and its not drawn change the player and</span>
<span class="sd">        jump to the idle state again so its the next players turn</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">next_players_turn</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Throw an turn ends event to refresh the gamestate for the clients</span>
<span class="sd">        and propagate the changes on the gamestate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">TURN_ENDS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">idle_state</span><span class="p">,</span> <span class="p">{})</span></div></div>


<div class="viewcode-block" id="CheckMoveState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.CheckMoveState">[docs]</a><span class="k">class</span> <span class="nc">CheckMoveState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks wheter a draw of a jumon is legal or not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;check_move_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="CheckMoveState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.CheckMoveState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the shortest path from the current position to the target</span>
<span class="sd">        position. Do the move if its legal, or jump back to the idle</span>
<span class="sd">        state if its not. Jump to the two tile battle state or the </span>
<span class="sd">        equip artefact state if the target position is occupied by an</span>
<span class="sd">        hostile jumon or an artefact</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the jumon, its current position and the target position</span>
        <span class="n">jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_move&quot;</span><span class="p">]</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;current_position&quot;</span><span class="p">]</span>
        <span class="n">target_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;target_position&quot;</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the shortes distance between the current position and the</span>
<span class="sd">        target position. Do the move only if the path is not none (aka a</span>
<span class="sd">        path is found) and the pathlength is less then or equal to the</span>
<span class="sd">        movements of the selected jumon. This way the jumons actually</span>
<span class="sd">        move and can be blocked by other meeples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">move_path</span> <span class="o">=</span> <span class="n">find_path</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="n">target_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">move_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">move_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>\
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">move_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">jumon</span><span class="o">.</span><span class="n">movement</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the target move is invalid in length just jump back to the</span>
<span class="sd">            idle state.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">idle_state</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">target_position</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the tile at target position is free just do the move</span>
<span class="sd">            and end the turn by jumping to the ChangePlayerState</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">target_position</span><span class="p">)</span><span class="o">.</span><span class="n">is_wasted</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the target position is a wasted arena tile kill the</span>
<span class="sd">                jumon</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">current_position</span><span class="p">)</span>
                <span class="n">jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot; Place the jumon on the arena tile &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">current_position</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">jumon</span><span class="p">,</span> <span class="n">target_position</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">change_player_state</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">player_chain</span><span class="o">.</span><span class="n">get_current_player</span><span class="p">()</span><span class="o">.</span>\
                <span class="n">owns_tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="n">target_position</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the target position is owned by a jumon of the current player</span>
<span class="sd">            the move is illegal and the a new move has to be defined,</span>
<span class="sd">            so jump back to the idle state</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">idle_state</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">target_position</span><span class="p">)),</span> <span class="n">Akuga</span><span class="o">.</span><span class="n">MatchServer</span><span class="o">.</span><span class="n">Meeple</span><span class="o">.</span><span class="n">Artefact</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the target position is occupied by an artefact jump to the</span>
<span class="sd">            equip artefact to jumon state</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the artefact at the target position</span>
            <span class="n">artefact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">target_position</span><span class="p">)</span>
            <span class="c1"># Move the jumon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">current_position</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">jumon</span><span class="p">,</span> <span class="n">target_position</span><span class="p">)</span>
            <span class="c1"># Jump to the equip artefact to jumon state</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">equip_artefact_to_jumon_state</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;jumon&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">,</span>
                <span class="s2">&quot;artefact&quot;</span><span class="p">:</span> <span class="n">artefact</span><span class="p">,</span>
                <span class="s2">&quot;last_position&quot;</span><span class="p">:</span> <span class="n">current_position</span><span class="p">})</span>  <span class="c1"># Its right think about it</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the target position is not empty and the jumon on target</span>
<span class="sd">            position is not owned by the current player it has to be</span>
<span class="sd">            a hostile jumon, so a TwoTileBattle is triggered</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">two_tile_battle_state_variable</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">jumon</span><span class="p">,</span>
                <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_unit_at</span><span class="p">(</span><span class="n">target_position</span><span class="p">),</span>
                <span class="s2">&quot;attack_position&quot;</span><span class="p">:</span> <span class="n">current_position</span><span class="p">,</span>
                <span class="s2">&quot;defense_position&quot;</span><span class="p">:</span> <span class="n">target_position</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">two_tile_battle_begin_state</span><span class="p">,</span> <span class="n">two_tile_battle_state_variable</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CheckSpecialMoveState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.CheckSpecialMoveState">[docs]</a><span class="k">class</span> <span class="nc">CheckSpecialMoveState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a special move is legal or not and invoke the special move</span>
<span class="sd">    function of the ability script of the current jumon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;check_special_move_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="CheckSpecialMoveState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.CheckSpecialMoveState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use the &#39;is_special_move_legal&#39; function of the current jumon</span>
<span class="sd">        to check if the move is legal or not. Invoke the special_move</span>
<span class="sd">        function of the current jumon if the move is legal.</span>
<span class="sd">        Go back to the idle state if its not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the jumon, its current position and the target position</span>
        <span class="n">jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon_to_move&quot;</span><span class="p">]</span>
        <span class="n">current_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;current_position&quot;</span><span class="p">]</span>
        <span class="n">target_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;target_position&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">jumon</span><span class="o">.</span><span class="n">is_special_move_legal</span><span class="p">(</span><span class="n">current_position</span><span class="p">,</span> <span class="n">target_position</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the special move is legal invoke the special move function</span>
<span class="sd">            of the current jumon</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">state_change</span> <span class="o">=</span> <span class="n">jumon</span><span class="o">.</span><span class="n">do_special_move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="p">,</span> <span class="n">current_position</span><span class="p">,</span>
                    <span class="n">target_position</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state_change</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If there is no special ability script at all the special</span>
<span class="sd">            move is illegal by default, so just jump to the idle_state</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">idle_state</span><span class="p">,</span> <span class="p">{})</span>
        <span class="c1"># Is never hit but nonetheless</span>
        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="OneTileBattleBeginState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleBeginState">[docs]</a><span class="k">class</span> <span class="nc">OneTileBattleBeginState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The start of a battle on one tile</span>
<span class="sd">    This state does nothing on its own, its just an entry point</span>
<span class="sd">    for special ability scripts of the fighting jumon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;one_tile_battle_begin_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="OneTileBattleBeginState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleBeginState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke the ability scripts of the fighting jumons and jump</span>
<span class="sd">        to the OneTileBattleFlipState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">one_tile_battle_flip_state</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="c1"># Do the state change</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="OneTileBattleFlipState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleFlipState">[docs]</a><span class="k">class</span> <span class="nc">OneTileBattleFlipState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state the arena tile at battle position is turned around</span>
<span class="sd">    and attached to the state informations. Then the state machiene</span>
<span class="sd">    immediatly jumps to the OneTileBattleBoniEvaluationStep</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;one_tile_battle_flip_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="OneTileBattleFlipState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleFlipState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arena tile at the battle position and add it to the state</span>
<span class="sd">        variables. Then jump to the OneTileBattleBoniEvaluationState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">battle_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;battle_position&quot;</span><span class="p">]</span>
        <span class="c1"># Get the battle arena tile</span>
        <span class="n">battle_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">battle_position</span><span class="p">)</span>
        <span class="c1"># Now jump to the OneTileBattleBoniEvaluationState</span>
        <span class="n">one_tile_battle_boni_evaluation_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">attacking_jumon</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="s2">&quot;battle_position&quot;</span><span class="p">:</span> <span class="n">battle_position</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After the arena tile has flipped invoke its ability script</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">battle_tile</span><span class="o">.</span><span class="n">one_tile_special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">attacking_jumon</span><span class="p">,</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">one_tile_battle_boni_evaluation_state</span><span class="p">,</span>
            <span class="n">one_tile_battle_boni_evaluation_state_variables</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="OneTileBattleBoniEvaluationState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleBoniEvaluationState">[docs]</a><span class="k">class</span> <span class="nc">OneTileBattleBoniEvaluationState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this State the bonus of the arena is evaluated and a bonus value</span>
<span class="sd">    for both jumons are added to the state variables. Then the state</span>
<span class="sd">    machiene jumps to the OneTileBattleFightState</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;one_tile_battle_boni_evaluation_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="OneTileBattleBoniEvaluationState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleBoniEvaluationState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the boni of the arena tile to the state variables and jump</span>
<span class="sd">        to the OneTileBattleFightState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">battle_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;battle_position&quot;</span><span class="p">]</span>
        <span class="n">battle_arena_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">battle_position</span><span class="p">)</span>
        <span class="n">attacking_jumon_bonus</span> <span class="o">=</span> <span class="n">battle_arena_tile</span><span class="o">.</span>\
            <span class="n">get_total_attack_bonus</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
        <span class="n">defending_jumon_bonus</span> <span class="o">=</span> <span class="n">battle_arena_tile</span><span class="o">.</span>\
            <span class="n">get_total_defense_bonus</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
        <span class="c1"># Create the state_variables</span>
        <span class="n">one_tile_battle_figh_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">attacking_jumon</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="s2">&quot;battle_position&quot;</span><span class="p">:</span> <span class="n">battle_position</span><span class="p">,</span>
            <span class="s2">&quot;attacking_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">attacking_jumon_bonus</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">defending_jumon_bonus</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After the bonus values are evaluated invoke the ability scripts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">one_tile_battle_fight_state</span><span class="p">,</span>
                <span class="n">one_tile_battle_figh_state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="n">state_change</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">state_change</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="OneTileBattleFightState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleFightState">[docs]</a><span class="k">class</span> <span class="nc">OneTileBattleFightState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state both jumons fight the victor and the looser are determined</span>
<span class="sd">    Then the state machiene jumps to the OneTileBattleAfterMathState</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;one_tile_battle_fight_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="OneTileBattleFightState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleFightState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fighting is pretty simple, the jumon with less power looses.</span>
<span class="sd">        If both jumons have the same power both jumon looses.</span>
<span class="sd">        Than the state machiene jumps to OneTileBattleAftermathState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">battle_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;battle_position&quot;</span><span class="p">]</span>
        <span class="n">attacking_jumon_bonus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon_bonus&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon_bonus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon_bonus&quot;</span><span class="p">]</span>
        <span class="c1"># If no one wins victor and looser are none</span>
        <span class="n">victor</span><span class="p">,</span> <span class="n">looser</span> <span class="o">=</span> <span class="n">jumon_fight</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">,</span> <span class="n">attacking_jumon_bonus</span><span class="p">,</span>
                                     <span class="n">defending_jumon</span><span class="p">,</span> <span class="n">defending_jumon_bonus</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The summoned jumon and the defending_jumon has to be in the variables</span>
<span class="sd">        as well to destroy both if victor and looser are None.</span>
<span class="sd">        Jump to the one_tile_battle_aftermath_state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">one_tile_battle_aftermath_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">attacking_jumon</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="s2">&quot;battle_position&quot;</span><span class="p">:</span> <span class="n">battle_position</span><span class="p">,</span>
            <span class="s2">&quot;attacking_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">attacking_jumon_bonus</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">defending_jumon_bonus</span><span class="p">,</span>
            <span class="s2">&quot;victor&quot;</span><span class="p">:</span> <span class="n">victor</span><span class="p">,</span>
            <span class="s2">&quot;looser&quot;</span><span class="p">:</span> <span class="n">looser</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run the ability scripts after victor and looser are determined,</span>
<span class="sd">        this way ability scripts can trigger if the bakugan wins or looses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">one_tile_battle_aftermath_state</span><span class="p">,</span>
                <span class="n">one_tile_battle_aftermath_state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="OneTileBattleAftermathState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleAftermathState">[docs]</a><span class="k">class</span> <span class="nc">OneTileBattleAftermathState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state the jumon which loosed the fight is removed from the</span>
<span class="sd">    arena and the summoned jumon list of the player.</span>
<span class="sd">    The jumon which won the fight will be placed on the arena tile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;one_tile_battle_aftermath_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="OneTileBattleAftermathState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.OneTileBattleAftermathState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kill the looser jumon, place the victor jumon,</span>
<span class="sd">        and swap the artefact from the victor to the looser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">victor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;victor&quot;</span><span class="p">]</span>
        <span class="n">looser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;looser&quot;</span><span class="p">]</span>
        <span class="n">battle_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;battle_position&quot;</span><span class="p">]</span>
        <span class="c1"># attacking_jumon_bonus = self.state_variables[&quot;attacking_jumon_bonus&quot;]</span>
        <span class="c1"># defending_jumon_bonus = self.state_variables[&quot;defending_jumon_bonus&quot;]</span>

        <span class="k">if</span> <span class="n">victor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">looser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If no victor and no looser is assigned both jumons had the same</span>
<span class="sd">            power level and both have to be destroyed</span>
<span class="sd">            If the attacker has an equipment attached to it detach it</span>
<span class="sd">            and place it on the arena tile</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">artefact</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">artefact</span><span class="p">,</span> <span class="n">battle_position</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the defender has an equipment attached to it detach it</span>
<span class="sd">            and place it on the arena tile. Cause this is handeld</span>
<span class="sd">            after the attacker the equipment of the defender overwrites</span>
<span class="sd">            the equipment of the attacker. This way the equipment of</span>
<span class="sd">            the attacker vanishes.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">artefact</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">artefact</span><span class="p">,</span> <span class="n">battle_position</span><span class="p">)</span>

            <span class="c1"># kill the jumons</span>
            <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
            <span class="n">defending_jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
            <span class="c1"># Remove the occupying unit from the arena tile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">battle_position</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">looser</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the looser had an artifact attached to it attach it to the</span>
<span class="sd">                winner instead</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">artifact</span> <span class="o">=</span> <span class="n">looser</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">looser</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">looser</span><span class="p">)</span>
                <span class="n">artifact</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="n">victor</span><span class="p">)</span>
            <span class="c1"># Now kill the looser</span>
            <span class="n">looser</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">looser</span><span class="p">)</span>
            <span class="c1"># Place the victor on the arena tile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">victor</span><span class="p">,</span> <span class="n">battle_position</span><span class="p">)</span>

        <span class="c1"># Now do the state_change (mostly jump to change_player_state)</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">change_player_state</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="TwoTileBattleBeginState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleBeginState">[docs]</a><span class="k">class</span> <span class="nc">TwoTileBattleBeginState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The start of a battle on two tiles</span>
<span class="sd">    This state does nothing on its own, its just an entry point</span>
<span class="sd">    for special ability scripts of the fighting jumon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;two_tile_battle_begin_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="TwoTileBattleBeginState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleBeginState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke the ability scripts of the fighting jumons and jump</span>
<span class="sd">        to the TwoTileBattleFlipState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">two_tile_battle_flip_state</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="TwoTileBattleFlipState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleFlipState">[docs]</a><span class="k">class</span> <span class="nc">TwoTileBattleFlipState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state the arena tiles at the battle positions are turned around</span>
<span class="sd">    and attached to the state informations. Then the state machiene</span>
<span class="sd">    immediatly jumps to the TwoTileBattleBoniEvaluationStep</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;two_tile_battle_flip_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="TwoTileBattleFlipState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleFlipState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the arena tiles at the battle positions and add them to the state</span>
<span class="sd">        variables. Then jump to the TwoTileBattleBoniEvaluationState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">attack_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attack_position&quot;</span><span class="p">]</span>
        <span class="n">defense_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defense_position&quot;</span><span class="p">]</span>
        <span class="c1"># Get the battle tiles</span>
        <span class="n">attack_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">attack_position</span><span class="p">)</span>
        <span class="n">defense_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">defense_position</span><span class="p">)</span>
        <span class="c1"># Now jump to the TwoTileBattleBoniEvaluationState</span>
        <span class="n">two_tile_battle_boni_evaluation_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">attacking_jumon</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="s2">&quot;attack_position&quot;</span><span class="p">:</span> <span class="n">attack_position</span><span class="p">,</span>
            <span class="s2">&quot;defense_position&quot;</span><span class="p">:</span> <span class="n">defense_position</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After the arena tiles has flipped invoke their ability scripts</span>
<span class="sd">        The attack tile triggers first! The state_change returned by</span>
<span class="sd">        the attack_tile has to be the input of the defense tile so</span>
<span class="sd">        both tiles can alter the state change and the state variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attack_tile</span><span class="o">.</span><span class="n">two_tile_special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">attacking_jumon</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">two_tile_battle_boni_evaluation_state</span><span class="p">,</span>
            <span class="n">two_tile_battle_boni_evaluation_state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defense_tile</span><span class="o">.</span><span class="n">two_tile_special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">defending_jumon</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="c1"># Do the state change</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="TwoTileBattleBoniEvaluationState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleBoniEvaluationState">[docs]</a><span class="k">class</span> <span class="nc">TwoTileBattleBoniEvaluationState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this State the bonus of the arena is evaluated and a bonus value</span>
<span class="sd">    for both jumons are added to the state variables. Then the state</span>
<span class="sd">    machiene jumps to the TwoTileBattleFightState</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;two_tile_battle_boni_evaluation_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="TwoTileBattleBoniEvaluationState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleBoniEvaluationState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the boni of the arena tiles to the state variables and jump</span>
<span class="sd">        to the TwoTileBattleFightState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">attack_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attack_position&quot;</span><span class="p">]</span>
        <span class="n">defense_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defense_position&quot;</span><span class="p">]</span>
        <span class="n">attack_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">attack_position</span><span class="p">)</span>
        <span class="n">defense_tile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_tile_at</span><span class="p">(</span><span class="n">defense_position</span><span class="p">)</span>

        <span class="c1"># Get the bonus of the attack or defense tile</span>
        <span class="n">attacking_jumon_bonus</span> <span class="o">=</span> <span class="n">attack_tile</span><span class="o">.</span>\
            <span class="n">get_total_attack_bonus</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
        <span class="n">defending_jumon_bonus</span> <span class="o">=</span> <span class="n">defense_tile</span><span class="o">.</span>\
            <span class="n">get_total_defense_bonus</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
        <span class="c1"># Now jump to the two_tile_battle_fight_state</span>
        <span class="n">two_tile_battle_figh_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">attacking_jumon</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="s2">&quot;attack_position&quot;</span><span class="p">:</span> <span class="n">attack_position</span><span class="p">,</span>
            <span class="s2">&quot;defense_position&quot;</span><span class="p">:</span> <span class="n">defense_position</span><span class="p">,</span>
            <span class="s2">&quot;attacking_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">attacking_jumon_bonus</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">defending_jumon_bonus</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After the bonus values are evaluated invoke the ability scripts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">two_tile_battle_fight_state</span><span class="p">,</span>
                <span class="n">two_tile_battle_figh_state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="c1"># Do the state change</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="TwoTileBattleFightState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleFightState">[docs]</a><span class="k">class</span> <span class="nc">TwoTileBattleFightState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state both jumons fight the victor and the looser are determined</span>
<span class="sd">    Then the state machiene jumps to the TwoTileBattleAfterMathState</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;two_tile_battle_fight_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="TwoTileBattleFightState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleFightState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fighting is pretty simple, the jumon with less power looses.</span>
<span class="sd">        If both jumons have the same power both jumon looses.</span>
<span class="sd">        Than the state machiene jumps to TwoTileBattleAftermathState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">attack_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attack_position&quot;</span><span class="p">]</span>
        <span class="n">defense_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defense_position&quot;</span><span class="p">]</span>
        <span class="n">attacking_jumon_bonus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon_bonus&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon_bonus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon_bonus&quot;</span><span class="p">]</span>
        <span class="c1"># If no one wins victor and looser are none</span>
        <span class="n">victor</span><span class="p">,</span> <span class="n">looser</span> <span class="o">=</span> <span class="n">jumon_fight</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">,</span> <span class="n">attacking_jumon_bonus</span><span class="p">,</span>
                                     <span class="n">defending_jumon</span><span class="p">,</span> <span class="n">defending_jumon_bonus</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The summoned jumon and the defending_jumon has to be in the variables</span>
<span class="sd">        as well to destroy both if victor and looser are None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">two_tile_battle_aftermath_state_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;attacking_jumon&quot;</span><span class="p">:</span> <span class="n">attacking_jumon</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon&quot;</span><span class="p">:</span> <span class="n">defending_jumon</span><span class="p">,</span>
            <span class="s2">&quot;attack_position&quot;</span><span class="p">:</span> <span class="n">attack_position</span><span class="p">,</span>
            <span class="s2">&quot;defense_position&quot;</span><span class="p">:</span> <span class="n">defense_position</span><span class="p">,</span>
            <span class="s2">&quot;attacking_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">attacking_jumon_bonus</span><span class="p">,</span>
            <span class="s2">&quot;defending_jumon_bonus&quot;</span><span class="p">:</span> <span class="n">defending_jumon_bonus</span><span class="p">,</span>
            <span class="s2">&quot;victor&quot;</span><span class="p">:</span> <span class="n">victor</span><span class="p">,</span>
            <span class="s2">&quot;looser&quot;</span><span class="p">:</span> <span class="n">looser</span><span class="p">}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run the ability scripts after victor and looser are determined,</span>
<span class="sd">        this way ability scripts can trigger if the bakugan wins or looses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">two_tile_battle_aftermath_state</span><span class="p">,</span>
                <span class="n">two_tile_battle_aftermath_state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="c1"># Do the state change</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="TwoTileBattleAftermathState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleAftermathState">[docs]</a><span class="k">class</span> <span class="nc">TwoTileBattleAftermathState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this state the jumon which loosed the fight is removed from the</span>
<span class="sd">    arena and the summoned jumon list of the player.</span>
<span class="sd">    The jumon which won the fight will be placed on the arena tile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;two_tile_battle_aftermath_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="TwoTileBattleAftermathState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.TwoTileBattleAftermathState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kill the looser, place the victor and swap the artefact from</span>
<span class="sd">        the victor to the looser.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacking_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attacking_jumon&quot;</span><span class="p">]</span>
        <span class="n">defending_jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defending_jumon&quot;</span><span class="p">]</span>
        <span class="n">attack_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;attack_position&quot;</span><span class="p">]</span>
        <span class="n">defense_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;defense_position&quot;</span><span class="p">]</span>
        <span class="n">victor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;victor&quot;</span><span class="p">]</span>
        <span class="n">looser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;looser&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">victor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">looser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If no victor and no looser is assigned both jumons had the same</span>
<span class="sd">            power level and both have to be destroyed</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># kill both jumons</span>
            <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
            <span class="n">defending_jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
            <span class="c1"># Remove both units from the arena tile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">attack_position</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">defense_position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the attacking_jumon had an artefact equiped drop it</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">artefact</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">artefact</span><span class="p">,</span> <span class="n">attack_position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the defending_jumon had an artefact equiped drop it</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">artefact</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">artefact</span><span class="p">,</span> <span class="n">defense_position</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">victor</span> <span class="ow">is</span> <span class="n">attacking_jumon</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the jumon to move has won move it to the defense tile</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Just kill the looser</span>
            <span class="n">defending_jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">defending_jumon</span><span class="p">)</span>
            <span class="c1"># Move the victor from the attack tile to the defense tile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">attack_position</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">victor</span><span class="p">,</span> <span class="n">defense_position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">looser</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the defender had an equipment it has to be detached</span>
<span class="sd">                from it and attached to the attacker</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">looser_artefact</span> <span class="o">=</span> <span class="n">looser</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">looser_artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">looser</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">victor</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    If the victor jumon has an equipment on its own it dropps</span>
<span class="sd">                    its artefact on the attack tile and attaches the</span>
<span class="sd">                    artefact of the defender jumon</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">victor_artefact</span> <span class="o">=</span> <span class="n">victor</span><span class="o">.</span><span class="n">equipment</span>
                    <span class="n">victor_artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">victor</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">victor_artefact</span><span class="p">,</span>
                        <span class="n">attack_position</span><span class="p">)</span>
                <span class="c1"># Attach the artefact of the defender to the attacker</span>
                <span class="n">looser_artefact</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="n">victor</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">victor</span> <span class="ow">is</span> <span class="n">defending_jumon</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the defending_jumon has won remove the attacking jumon</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Just kill the looser</span>
            <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">owned_by</span><span class="o">.</span><span class="n">handle_jumon_death</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">attack_position</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                If the attacking jumon had an equipment it drops it on the</span>
<span class="sd">                attack tile</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># Detach the artefact from the jumon</span>
                <span class="n">attack_artefact</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">equipment</span>
                <span class="n">attack_artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">attacking_jumon</span><span class="p">)</span>
                <span class="c1"># Place it on the attack tile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">attack_artefact</span><span class="p">,</span> <span class="n">attack_position</span><span class="p">)</span>
        <span class="c1"># Now the turn ends so do the change</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">attacking_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">change_player_state</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">))</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">defending_jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>


<div class="viewcode-block" id="EquipArtefactToJumonState"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.EquipArtefactToJumonState">[docs]</a><span class="k">class</span> <span class="nc">EquipArtefactToJumonState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Equips an artefact to a jumon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsm</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;equip_artefact_to_jumon_state&quot;</span><span class="p">,</span> <span class="n">fsm</span><span class="p">)</span>

<div class="viewcode-block" id="EquipArtefactToJumonState.run"><a class="viewcode-back" href="../../../Akuga.MatchServer.html#Akuga.MatchServer.AkugaStates.EquipArtefactToJumonState.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attaches an equipment to a jumon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jumon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;jumon&quot;</span><span class="p">]</span>
        <span class="n">artefact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;artefact&quot;</span><span class="p">]</span>
        <span class="n">last_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_variables</span><span class="p">[</span><span class="s2">&quot;last_position&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">jumon</span><span class="o">.</span><span class="n">equipment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the jumon has no equipment yet just attach it</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">artefact</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the jumon has an equipment attached it has to be detached</span>
<span class="sd">            and placed at the old position. In the very special case</span>
<span class="sd">            a jumon is summoned with an equipment attached to it</span>
<span class="sd">            aka last_position is None discard it</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the artefact to detach and detach it from the jumon</span>
            <span class="n">detached_artefact</span> <span class="o">=</span> <span class="n">jumon</span><span class="o">.</span><span class="n">equipment</span>
            <span class="n">detached_artefact</span><span class="o">.</span><span class="n">detach_from</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="c1"># Attach the current artefact to the jumon</span>
            <span class="n">artefact</span><span class="o">.</span><span class="n">attach_to</span><span class="p">(</span><span class="n">jumon</span><span class="p">)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Just place the detached artefact on the arena again if the</span>
<span class="sd">            last position is not None like it would be if the jumon</span>
<span class="sd">            was just summoned. This presupposes there is a jumon</span>
<span class="sd">            which is summoned with an artefact attached to it</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">last_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">place_unit_at</span><span class="p">(</span><span class="n">detached_artefact</span><span class="p">,</span> <span class="n">last_position</span><span class="p">)</span>
        <span class="c1"># Invoke the special ability of the jumon and do the state change</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fsm</span><span class="o">.</span><span class="n">change_player_state</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">state_change</span> <span class="o">=</span> <span class="n">jumon</span><span class="o">.</span><span class="n">special_ability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_change</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_change</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Akuga</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Akuga.html">Akuga package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, AkugaSphinxDocs.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>